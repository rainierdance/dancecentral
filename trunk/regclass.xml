<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="DanceCentral.info Studio Management - Classes"
             description="DanceCentral.info Studio Management"
             author="DanceCentral.info"
             >
<Require feature="idi"/>
<Require feature="setprefs" />
<Require feature="locked-domain" />
</ModulePrefs>
<UserPref name="classesDataUrl" display_name="Classes Data url"
          required="true"/>
<Content type="html"><![CDATA[
<script src="http://www.google.com/jsapi" type="text/javascript"></script>

<script>
function escapeHtml(text) {
  if (text == null) {
    return '';
  }
  //return _hesc(text);
  return text;
}

/**
 * Load the APIs and run sendStudentQuery when the load is complete
 */
var gadgetHelper = null;
_IG_RegisterOnloadHandler(loadVisualizationAPI);
function loadVisualizationAPI() {
  google.load("visualization", "1");
  google.setOnLoadCallback(sendClassesQuery);
}

/**
 * Create a query (shaped by the Gadget's user preferences), then
 * send it to the spreadsheet data source. Also give the name of a
 * function ("handleQueryResponse") to run once the spreadsheet data
 * is retrieved:
 */
var prefs = new _IG_Prefs(); // User preferences

function sendClassesQuery() {
  prefs.set('_table_query_url', prefs.getString('classesDataUrl'));
  gadgetHelper = new google.visualization.GadgetHelper();
  var query = gadgetHelper.createQueryFromPrefs(prefs);
  query.send(handleClassesQueryResponse);
}

function handleClassesQueryResponse(response) {
  if (!gadgetHelper.validateResponse(response)) {
    return;     // Default error handling was done, just leave.
  }
  var data = response.getDataTable();
  for (var row = 0; row < data.getNumberOfRows(); row++) {
    var category = data.getFormattedValue(row,1);
    if (category != 'Series' && category != 'Drop-in')
        continue;
    gAllClasses.push({
      'title' : data.getFormattedValue(row,0),
      'category' : data.getFormattedValue(row,1), 
      'start_date' : data.getFormattedValue(row,2), // could be empty
      'day_of_week' :data.getFormattedValue(row,3),
      'start_time' : data.getFormattedValue(row,4),
      'style': data.getFormattedValue(row,5),
      'dance_name' : data.getFormattedValue(row,6),
      'level' : data.getFormattedValue(row,7), 
      'description' : data.getFormattedValue(row,8),
      'teacher' : data.getFormattedValue(row,9),
      'bio' : data.getFormattedValue(row,10)
    });
  }

  showFilters();
}

</script>

<body onload='onLoad()'>
<style>
td, body {
  font-family: Arial, sans-serif;
  font-size: 0.8em;
}
a:hover {text-decoration: underline; color: red; background: #fafad2;}
.errMsg {background-color: #ffe6cc; border: 2px solid #c43b1d; padding: 2px;}
.good {background-color: #ffffff; border: 0px; padding: 0px;}
</style>

<script>
var IS_GADGET = true;
var VERSION = "12.0213.2354";

////////////////////////////////////////////////////////////////////////
// Globals

// read from data file, current ongoing classes
var gAllClasses = [];
var gAllFilters = {};
var resultList = null;
var filterKeys = {
  'style' : ['Style', 4], // how many per row
  'level' : ['Level', 4], //there are very few classes after user filter by style
  'day_of_week' : ['Day', 7]
  //'teacher' : 'Teacher',  // maybe later
}; 


////////////////////////////////////////////////////////////////////////
<!-- Utilities -->
function formatDate(dateObj) {
  return dateObj.getFullYear() + '-' +
   ('' + (100 + dateObj.getMonth() + 1)).substring(1) + '-' +
   ('' + (100 + dateObj.getDate())).substring(1);
}

////////////////////////////////////////////////////////////////////////
// 

function sortClasses(classes) {
  var sorted = [];
  for (var i = 0; i< classes.length; i++) {
    for (var j=0; j < sorted.length; j++) {
      if (classes[i]['title'] < sorted[j]['title']) {
        break; 
      }
    }
    sorted.splice(j, 0, classes[i]);
  }
  return sorted;
}

// filter: key: possible values (each key: or)
function filterClasses(filter) {
  if (!filter) return sortClasses(gAllClasses);

  var classes = [];
  for (var i = 0; i < gAllClasses.length; i++ ) {
    var match = true;
    for (var key in filter) {
     //  AND relation, if not a match, break out
     // check each filter value
     var values = filter[key];
     var len = values.length;
     var found = false;
     if (len != 0) { // if non is selected, it's match
       for (var j=0; j < len; j++) { // if found a match, true
         if (gAllClasses[i][key] == '') {
           found = true; // any level class match any selected values
           break;
         }
         var class_values = gAllClasses[i][key].split(',');
         for (var k = 0; k<class_values.length; k++) {
           var class_value = class_values[k].replace(/^\s+|\s+$/g,"");
           if (class_value == values[j]) {
             found = true;
             break;
           }
         }
         if (found) break;
       }
     } else {
       found = true;
     }
     if (!found) {
       match = false;
       break;
     }
    }
    if (match) classes.push(gAllClasses[i]);
  }

  return sortClasses(classes);
}

function showClasses(filter) {
  resultList = filterClasses(filter)

  if (resultList.length == 0) {
    _gel('idEntityList').innerHTML = 'No matching classes.'
   return;
  }
    
  var html = [];
  for (var i = 0; i < resultList.length; i++) {
    html.push('<a href="javascript:void(0)" onclick="showClassDetails(' +
      i + ')" +' + 
//      ' onmouseover="showClassDetails(' + i + ')"' +  
      ' >' + resultList[i]['title'] + '</a><br>');
  }
  _gel('idEntityList').innerHTML = html.join('');
}

function updateFilter() {
  _gel('idEntityDetails').innerHTML = ''; // clear details, as result will change
  _gel('signUpPanel').style.display = 'None';

  // get filters from checkbox
  var fmFilter = _gel('fmFilter');
  var filter = {};
  for (var key in filterKeys) {
    var filterOptions = fmFilter['filterChk' + key];
    var len = filterOptions.length;
    var values = [];
    for (var i=0; i<len; i++) {
      if (filterOptions[i].checked) values.push(filterOptions[i].value);
    }
    filter[key] = values;
  }

  showClasses(filter);
}

function showClassDetails(index) {
  var groupClass = resultList[index];
  var html = [];
  html.push('<div style="font-weight:bold">' + groupClass['title'] + '</div><p>');
  html.push('<div style="border: 1px solid #cc0000; padding: 2px; line-height:1.3"><table width=100% border=0 style="border-collapse:collapse" cellspacing=4 cellpadding=2 ><tr>');
  html.push('<td valign=top>Category: ' + groupClass['category'] + (groupClass['category'] == 'Series' ? ' (4 classes)' : '') + '<br>');
  html.push(groupClass['style'] + ' ' + groupClass['dance_name'] + '</td>');
  html.push('<td valign=top align=left>' + (groupClass['category'] == 'Series' ? 'Starting ' : '') + groupClass['start_date'] + ' ' +  groupClass['day_of_week'] + 
    ' ' + groupClass['start_time'] + '<br>');
  html.push((groupClass['level'] ?  groupClass['level'] : 'Level: Any')+ '<br>');
  if (groupClass['teacher']) {
    html.push('Instructor: <a href="' + groupClass['bio'] + '" target="_blank">' + groupClass['teacher'] + '</a>');
  }
  html.push('</td><tr></table></div>');

  html.push('<p><span style="line-height:1.3">' + groupClass['description'] + '</span><br>');
  _gel('idEntityDetails').innerHTML = html.join('');

  // fill in Sign Up Panel
  //clean up from before
  _gel('idFrameSubmit').src = 'about:blank';
  _gel('entry_7').value = ''; // clean up the note, leave other fields.

  _gel('entry_4').value = groupClass['title']; 
  _gel('signUpPanel').style.display = '';
}

function indexOf(obj, value) {
  if (!obj) return -1;
  for (var i = 0; i < obj.length; i++) {
    if (obj[i] == value) { return i; }
  }
  return -1;
}

function showFilters() {
  // fill in the filters
  for (var key in filterKeys) {
   gAllFilters[key] = [];
  }

  var key;
  for (var i = 0; i < gAllClasses.length; i++) {
    for (var key in filterKeys) {
      // ',' can be used as delimiter if a class has more than 1 value for the key
      var values = gAllClasses[i][key].split(',');
      // trim spaces
      for (var j = 0; j<values.length; j++) {
        var value = values[j].replace(/^\s+|\s+$/g,"");
        if (gAllClasses[i][key] && (indexOf(gAllFilters[key], value) == -1)) {
          gAllFilters[key].push(value);
        }
      }
    }
  }

  var keyNo = 0;
  var html = ['<table cellspacing=2 cellpadding=0>'];
  for (var key in filterKeys) {
    var len = gAllFilters[key].length;
    html.push('<tr><td valign=center><span style="color:rgb(204,0,0); font-size:12pt; font-weight:bold">' + filterKeys[key][0] + '</span></td><td>');
    html.push('<table>');
    for (var i = 0; i<len; i++) { // 4 options in a row
      if (i % filterKeys[key][1] == 0) html.push('<tr>');
      var idLabel = 'key' + keyNo + '_' + i;
      html.push('<td><input type="checkbox" name="filterChk' + key + 
        '" onclick="updateFilter()" value="' + gAllFilters[key][i]+ '" id="' + idLabel + '" /><label for="' +
        idLabel + '">&nbsp;' + gAllFilters[key][i] + "</label> &nbsp; </td>");
      if (i % 4 == (filterKeys[key][1]-1)) html.push('</tr>');
    }
    html.push('</table>');
    keyNo++;
    html.push('</td></tr>');
    html.push('<tr><td colspan=2><hr style="background-color:rgb(204,204,204);border-top-style:none;border-right-style:none;border-bottom-style:none;border-left-style:none;height:1px"></td></tr>');
  }
  html.push('</table>');
   _gel('filterSelection').innerHTML = html.join('');

  showClasses(); // show all clases
}

function showAllClasses() {
  // reset
  _gel('fmFilter').reset();
  _gel('idEntityDetails').innerHTML = '';
  _gel('signUpPanel').style.display = 'None';

  // display all classes
  showClasses();
}

// return true to submit the form
function checkData() {
  if (!_gel('entry_0').value) { // need name
   _gel('inputName').className = 'errMsg';
   return false;
  }
   _gel('inputName').className = 'good';

  if (!_gel('group_1_1').checked && !_gel('group_1_2').checked) { // need lead and follow
   _gel('inputGender').className = 'errMsg';
   return false;
  }
   _gel('inputGender').className = 'good';

  _gel('entry_7').value = ''; // clean previous error
  return true;
}

</script> 

<!--- UI elements --->

<!-- Search header, always shown -->
<div style="float:normal">
Narrow down your choices by checking the boxes. &nbsp; &nbsp; &nbsp; 
<a href="javascript:void(0)" onclick="showAllClasses()">Show all classes</a></div>
<p>
<form id="fmFilter">
<div id='filterSelection'></div>
</form>

<!-- Search result list + each participant details -->
<table cellspacing=10 id='idSearchResult'>
<tr><td valign=top nowrap>
<div id="idEntityList" style="overflow: auto;line-height:1.3"><img src="http://www.google.com/ig/images/spinner.gif" /></div>
</td>
<td valign=top>
<div id='idEntityDetails'></div>

<div id='signUpPanel' style="display:None">
<form target="frmSubmit" 
  action="https://docs.google.com/a/ariaballroom.com/spreadsheet/formResponse?formkey=dDBrVDhLRGdlQ0ZiSndDaXAyMldzY2c6MQ&amp;ifq" 
  method="POST" id="ss-form" onSubmit="return checkData()">
<b>Sign up now for this class to reserve your spot:</b> <p>
<span id="inputName">
Your name: <input type="text" name="entry.0.single" value="" class="ss-q-short" id="entry_0" size=30> &nbsp;</span> 
<span id="inputGender">
<input type="radio" name="entry.1.group" value="Lead" class="ss-q-radio" id="group_1_1"><label for="group_1_1"> Lead</label> &nbsp; &nbsp;
<input type="radio" name="entry.1.group" value="Follow" class="ss-q-radio" id="group_1_2"><label for="group_1_2">Follow</label> &nbsp; </span><p>

In case of class changes, how can we reach you? (Optional)<br>
Email: <input type="text" name="entry.2.single" value="" class="ss-q-short" id="entry_2" size=40>
Phone: <input type="text" name="entry.6.single" value="" class="ss-q-short" id="entry_6" size=15><p>
<input type="hidden" name="entry.4.single" value="" class="ss-q-short" id="entry_4"> <!-- class name -->
Question? Commments? Leave us a note:<br>
<textarea name="entry.7.single" rows="3" cols="50" class="ss-q-long" id="entry_7"></textarea>
<br>
<input type="hidden" name="pageNumber" value="0">
<input type="hidden" name="backupCache" value="">


<input type="submit" name="submit" value="Submit">

</form>
</div>

<!-- Visible to make sure form post is successful -->
<div>
<iframe name="frmSubmit" id='idFrameSubmit' width=500 height=200 frameborder=0 scrolling=no></iframe>
</div>

</div>
</td>
</tr>
</table>


</body>
]]></Content>
</Module>

