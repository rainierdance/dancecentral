<body onload='onLoad()'>
<style>
td, body {
  font-family: Arial, sans-serif;
  font-size: 0.8em;
}
a:hover {text-decoration: underline; color: red; background: #fafad2;}
.errMsg {background-color: #ffe6cc; border: 2px solid #c43b1d; padding: 2px;}
.good {background-color: #ffffff; border: 0px; padding: 0px;}
</style>

<script>
var IS_GADGET = false;
var VERSION = "$Rev$";

////////////////////////////////////////////////////////////////////////
// Globals

// read from data file, current ongoing classes
var gAllClasses = [];
var gAllFilters = {};

////////////////////////////////////////////////////////////////////////
<!-- Utilities -->
function formatDate(dateObj) {
  return dateObj.getFullYear() + '-' +
   ('' + (100 + dateObj.getMonth() + 1)).substring(1) + '-' +
   ('' + (100 + dateObj.getDate())).substring(1);
}

////////////////////////////////////////////////////////////////////////
// 

var resultList = null;

function sortClass(class1, class2) {
  return class1['title'] > class2['title'];
}

// filter: key: possible values (each key: or)
function filterClasses(filter) {
  if (!filter) return gAllClasses.sort(sortClass);

  var classes = [];
  for (var i = 0; i < gAllClasses.length; i++ ) {
    var match = true;
    for (var key in filter) {
     //  AND relation, if not a match, break out
     // check each filter value
     var values = filter[key];
     var len = values.length;
     var found = false;
     if (len != 0) { // if non is selected, it's match
       for (var j=0; j < len; j++) { // if found a match, true
         if (gAllClasses[i][key] == values[j]) {
           found = true;
           break;
         }
       }
     } else {
       found = true;
     }
     if (!found) {
       match = false;
       break;
     }
    }
    if (match) classes.push(gAllClasses[i]);
  }

  return classes.sort(sortClass);
}

function showClasses(filter) {
  resultList = filterClasses(filter)

  if (resultList.length == 0) {
    _gel('idEntityList').innerHTML = 'No matching classes.'
   return;
  }
    
  var html = [];
  for (var i = 0; i < resultList.length; i++) {
    html.push('<a href="javascript:void(0)" onclick="showClassDetails(' +
      i + ')" onmouseover="showClassDetails(' + i + ')">' +
      resultList[i]['title'] + '</a><br>');
  }
  _gel('idEntityList').innerHTML = html.join('');
}

function updateFilter() {
  _gel('idEntityDetails').innerHTML = ''; // clear details, as result will change

  // get filters from checkbox
  var fmFilter = _gel('fmFilter');
  var filter = {};
  for (var key in filterKeys) {
    var filterOptions = fmFilter['filterChk' + key];
    var len = filterOptions.length;
    var values = [];
    for (var i=0; i<len; i++) {
      if (filterOptions[i].checked) values.push(filterOptions[i].value);
    }
    filter[key] = values;
  }

  showClasses(filter);
}

function showClassDetails(index) {
  var groupClass = resultList[index];
  var html = [];
  html.push('<div style="font-weight:bold">' + groupClass['title'] + '</div><p>');
  html.push('Category: ' + groupClass['category'] + '<br>');
  html.push('Class time: ' + groupClass['start_date'] + ' ' +  groupClass['day_of_week'] + 
    ' ' + groupClass['start_time'] + '<br>');
  html.push('Style: ' + groupClass['style'] + ' ' + groupClass['dance_name'] + '<br>');
  html.push('Level: ' + groupClass['level'] + '<br>');
  html.push('Teacher: <a href="' + groupClass['bio'] + '" target="_blank">' + groupClass['teacher'] + '</a><p>');
  html.push(groupClass['description'] + '<br>');
  _gel('idEntityDetails').innerHTML = html.join('');

  // fill in Sign Up Panel
  //clean up from before
  _gel('idFrameSubmit').src = 'about:blank';
  _gel('entry_7').value = ''; // clean up the note, leave other fields.

  _gel('signUpClassName').innerHTML = groupClass['title'];
  _gel('entry_4').value = groupClass['title']; 
  _gel('signUpPanel').style.display = '';
}

var filterKeys = {
  'style' : 'Style',
  'level' : 'Level', //there are very few classes after user filter by styel
  // 'day_of_week' : 'Day of Week',
  //'teacher' : 'Teacher',  // maybe later
}; 

function showFilters() {
  // fill in the filters
  for (var key in filterKeys) {
   gAllFilters[key] = [];
  }

  var key;
  for (var i = 0; i < gAllClasses.length; i++) {
    for (var key in filterKeys) {
      if (gAllClasses[i][key] && (gAllFilters[key].indexOf(gAllClasses[i][key]) == -1)) {
        gAllFilters[key].push(gAllClasses[i][key]);
      }
    }
  }

  var keyNo = 0;
  var html = ['<table cellspacing=0 cellpadding=0>'];
  for (var key in filterKeys) {
    var len = gAllFilters[key].length;
    html.push('<tr><td valign=top>' + filterKeys[key] + '</td><td>');
    html.push('<table>');
    for (var i = 0; i<len; i++) { // 4 options in a row
      if (i % 4 == 0) html.push('<tr>');
      var idLabel = 'key' + keyNo + '_' + i;
      html.push('<td><input type="checkbox" name="filterChk' + key + 
        '" onclick="updateFilter()" value="' + gAllFilters[key][i]+ '" id="' + idLabel + '" /><label for="' +
        idLabel + '">&nbsp;' + gAllFilters[key][i] + "</label> &nbsp; </td>");
      if (i % 4 == 3) html.push('</tr>');
    }
    html.push('</table>');
    keyNo++;
    html.push('</td></tr>');
  }
  html.push('</table>');
   _gel('filterSelection').innerHTML = html.join('');

  showClasses(); // show all clases
}

function showAllClasses() {
  // reset
  _gel('fmFilter').reset();
  _gel('idEntityDetails').innerHTML = '';
  _gel('signUpPanel').style.display = 'None';

  // display all classes
  showClasses();
}

// return true to submit the form
function checkData() {
  if (!_gel('entry_0').value) { // need name
   _gel('inputName').className = 'errMsg';
   return false;
  }
   _gel('inputName').className = 'good';

  if (!_gel('group_1_1').checked && !_gel('group_1_2').checked) { // need lead and follow
   _gel('inputGender').className = 'errMsg';
   return false;
  }
   _gel('inputGender').className = 'good';

  _gel('entry_7').value = ''; // clean previous error
  return true;
}

</script> 

<!--- UI elements --->

<!-- Search header, always shown -->
<div style="float:normal">
Narrow down your classes by selecting the check boxes. &nbsp; &nbsp; &nbsp; 
<a href="javascript:void(0)" onclick="showAllClasses()">Show all classes</a></div>
<p>
<form id="fmFilter">
<div id='filterSelection'></div>

<!-- Search result list + each participant details -->
<table cellspacing=15 id='idSearchResult'>
<tr><td valign=top nowrap>
<div id="idEntityList" style="overflow: auto;"><img src="http://www.google.com/ig/images/spinner.gif" /></div>
</td>
</form>
<td valign=top>
<div id='idEntityDetails'></div>
<div id='signUpPanel' style="display:None">
<form target="frmSubmit" 
  action="https://docs.google.com/a/ariaballroom.com/spreadsheet/formResponse?formkey=dDBrVDhLRGdlQ0ZiSndDaXAyMldzY2c6MQ&amp;ifq" 
  method="POST" id="ss-form" onSubmit="return checkData()">
<b>Sign up now for this class to reserve your spot:</b> <p>
Class: <span id='signUpClassName' style="font-weight:normal"></span><br>
<span id="inputName">
Your name: <input type="text" name="entry.0.single" value="" class="ss-q-short" id="entry_0" size=30> &nbsp;</span> 
<span id="inputGender">
<input type="radio" name="entry.1.group" value="Lead" class="ss-q-radio" id="group_1_1"><label for="group_1_1"> Lead</label> &nbsp; &nbsp;
<input type="radio" name="entry.1.group" value="Follow" class="ss-q-radio" id="group_1_2"><label for="group_1_2">Follow</label> &nbsp; </span><br>

In case we need to reach you about class changes, how can we reach you? (Optional)<br>
Email: <input type="text" name="entry.2.single" value="" class="ss-q-short" id="entry_2" size=40>
Phone: <input type="text" name="entry.6.single" value="" class="ss-q-short" id="entry_6" size=15><br>
<input type="hidden" name="entry.4.single" value="" class="ss-q-short" id="entry_4"> <!-- class name -->
Question? Commments? Leave us a note:<br>
<textarea name="entry.7.single" rows="3" cols="50" class="ss-q-long" id="entry_7"></textarea>
<br>
<input type="hidden" name="pageNumber" value="0">
<input type="hidden" name="backupCache" value="">


<input type="submit" name="submit" value="Submit">

</form>
</div>

<!-- Visible to make sure form post is successful -->
<div>
<iframe name="frmSubmit" id='idFrameSubmit' width=500 height=200 frameborder=0 scrolling=no></iframe>
</div>

</td>
</tr>
</table>

<script type="text/javascript" SRC="localonly.js"></script>

</body>
